name: Circle calls

__definitions__:
  - | 
    circle_qc_plot_link = f"""
    function(value, row) {{
      let graph_id = row["graph_id"]
      let circle_id = row["circle_id"]
      let link = `<a data-toggle="tooltip" data-placement="top" title="QC plot" href='./qc_plots/graph_${{graph_id}}_${{circle_id}}.html' target='_blank'>${{value}}</a>`;
      return link;
    }}
    """
  - | 
    graph_link = f"""
    function(value, row) {{
      let graph_id = value;
      let link = `<a data-toggle="tooltip" data-placement="top" title="graph structure" href='./graphs/graph_${{graph_id}}.pdf' target='_blank'>${{value}}</a>`;
      return link;
    }}
    """
  - |
    gene_link = f"""
    function(value, row) {{
        $(function () {{
            $('[data-toggle="tooltip"]').tooltip()
        }});
            let genes = value.split(",");
            let rows = "";
            for (let g of genes) {{
                rows = `${{rows}}<tr><td><a data-toggle="tooltip" title="Linkout to genecards" href="https://www.genecards.org/cgi-bin/carddisp.pl?gene=${{g}}" target="_blank">${{g}}</a></td></tr>`;
            }};
            let table = `<div style="overflow-y: auto; max-height: 30vh; min-width: 140px;"><table class="table"><thead><tr><th scope="col">Genes</th></tr></thead><tbody>${{rows}}</tbody></table></div>`;
            let button = `<a href='#' tabindex='0' class='btn btn-primary' role='button' data-toggle='popover' data-placement="left" data-trigger='focus' data-html='true' data-content='${{table}}'><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
            <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm15 2h-4v3h4V4zm0 4h-4v3h4V8zm0 4h-4v3h3a1 1 0 0 0 1-1v-2zm-5 3v-3H6v3h4zm-5 0v-3H1v2a1 1 0 0 0 1 1h3zm-4-4h4V8H1v3zm0-4h4V4H1v3zm5-3v3h4V4H6zm4 4H6v3h4V8z"/>
            </svg></a>`;
            return button;
    }}
    """
  - |
    breakpoint_link = f"""
    function(value, row) {{
        let primer_blast_url = `https://www.ncbi.nlm.nih.gov/tools/primer-blast/index.cgi?LINK_LOC=bookmark&INPUT_SEQUENCE=${{value}}&PRIMER5_END=900&PRIMER3_START=1100&PRIMER_PRODUCT_MIN=200&PRIMER_PRODUCT_MAX=1200&ORGANISM=Homo%20sapiens&NEWWIN=on&NEWWIN=on&SHOW_SVIEWER=true`;
        let seq = "…" + value.substring(value.length / 2 - 10, value.length / 2 + 10) + "…";
        let link = `<a data-toggle="tooltip" data-placement="top" title="primer-blast" href="${{primer_blast_url}}">${{seq}}</a>`;
        return link;
    }}
    """
  - |
    regions_links = f"""
    function(value, row) {{
        let regions = value.split(",");
        let links = [];
        for (let region of regions) {{
            let ensembl_url = `https://www.ensembl.org/Homo_sapiens/Location/Overview?r=${{region}}`;
            let link = `<a data-toggle="tooltip" data-placement="top" title="ensembl-genome-browser" href="${{ensembl_url}}">${{region}}</a>`;
            links.push(link);
        }}
        let result = links.join(", ");
        return result;
    }}
    """

default-view: "summary-plot"

datasets:
  ?for category, path in params.overview_tables:
    ?f"data-{category}-circles":
      path: ?path
      separator: "\t"
      links:
        circle-details:
          column: event_id
          view: ?f"detail-{params.group}-{{value}}-segments"
  ?for category, circle, path in params.detail_tables:
    ?f"data-{category}-{circle}-segments":
      path: ?path
      separator: "\t"
  "overview-table":
    path: ?params.categorized_table
    separator: "\t"

views:
  ?for category in params.categories:
    ?f"circles-{category}":
      desc: |
        Overview table showing all discovered circles for a category.
      dataset: ?f"data-{category}-circles"
      render-table:
        columns:
          "graph_id":
            custom: ?graph_link
          "circle_id":
            custom: ?circle_qc_plot_link
          "regions":
            custom: ?regions_links
          "circle_length":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "circle_length"
          "segment_count":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "segment_count"
          "num_split_reads":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "num_split_reads"
          "regex('prob_(.+)')":
            plot:
              heatmap:
                scale: linear
                domain: [0.0, 1.0]
                range:
                  - white
                  - "#c1d7a8"
          "gene_names":
            custom: ?gene_link
          "gene_ids":
            display-mode: hidden
          "num_exons":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "num_exons"
          "regex('af_(.+)')":
            plot: 
              ticks:
                scale: "linear"
                domain: [0.0, 1.0]
                aux-domain-columns:
                  - "regex('af_(.+)')"

  ?for category, circle, _ in params.detail_tables:
    ?f"detail-{category}-{circle}-segments":
      hidden: true
      desc: |
        Detail table containing all covered segments and circle junctions for a circle
      dataset: ?f"data-{category}-{circle}-segments"
      render-table:
        columns:
          "kind":
            plot:
              heatmap:
                scale: ordinal
                color-scheme: accent
          "length":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "length"
          "num_exons":
            plot: 
              ticks:
                scale: "linear"
                aux-domain-columns:
                  - "num_exons"
          "coverage":
            plot: 
              ticks:
                scale: "sqrt"
                aux-domain-columns:
                  - "coverage"
          "num_split_reads": 
            plot:
              ticks:
                scale: "sqrt"
                aux-domain-columns:
                  - "num_split_reads"
          "breakpoint_sequence":
            custom: ?breakpoint_link
          "gene_names":
            custom: ?gene_link
          "gene_ids":
            display-mode: hidden

  "summary-plot":
    desc: |
      Circle length distribution for different categories of circles.
    dataset: ?f"overview-table"
    render-plot:
      spec-path: ?params.summary_spec